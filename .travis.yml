language:
  - python
  - node_js
sudo: required
dist: trusty
cache:
  directories:
    - buildout-cache
python:
  - 2.7
node_js:
  - "6.1"
env:
  global:
    - ROBOT_BUILD_NUMBER=travis-$TRAVIS_BUILD_NUMBER
    - ROBOT_REMOTE_URL=http://$SAUCE_USERNAME:$SAUCE_ACCESS_KEY@ondemand.saucelabs.com:80/wd/hub
    - ROBOT_DESIRED_CAPABILITIES=tunnel-identifier:$TRAVIS_JOB_ID
    - CXX=g++-4.8
addons:
  sauce_connect:
    - username: $SAUCE_USERNAME
    - access_key: $SAUCE_ACCESS_KEY
  firefox: "50.0"
  apt:
    sources:
      - ubuntu-toolchain-r-test
      - google-chrome
    packages:
      - g++-4.8
      - google-chrome-stable

before_install:
  - sudo apt-get update
#  - wget http://security.ubuntu.com/ubuntu/pool/main/i/icu/libicu52_52.1-3ubuntu0.4_amd64.deb
#  - sudo dpkg -i libicu52_52*.deb
  - nvm install 6.1
  - nvm use 6.1
  - npm i -g npm@3
  - npm i -g typescript@2.1.4
  - npm --version
  - node --version
  - tsc --version
  - wget 'https://download.mozilla.org/?product=firefox-nightly-latest&lang=en-US&os=linux64' -O firefox-nightly.tar.bz2
  - tar xvf firefox-nightly.tar.bz2
  - export PATH=\"$PWD/firefox/\":$PATH
  - wget https://github.com/mozilla/geckodriver/releases/download/v0.14.0/geckodriver-v0.14.0-linux64.tar.gz
  - mkdir geckodriver
  - tar -xzf geckodriver-v0.14.0-linux64.tar.gz -C geckodriver
  - export PATH=$PATH:$PWD/geckodriver
  - sudo apt-get install chromium-chromedriver
  - export PATH=$PATH:/usr/lib/chromium-browser/
install:
  - npm --version
  - node --version
  - tsc --version
  - mkdir -p buildout-cache/{eggs,downloads}
  - python bootstrap-buildout.py -v 2.2.5 --setuptools-version=8.3 -c travis.cfg
  - bin/buildout -Nc travis.cfg
  - cat bin/test
  - bin/buildout -Nc travis.cfg annotate
  - npm cache clean
  - npm set registry http://registry.npmjs.org
  - npm update -g
  - cd ide && npm install && npm run build && cd ..
before_script:
  - "export DISPLAY=:99.0"
  - "sh -e /etc/init.d/xvfb start"
  - sleep 3 # give xvfb some time to start
script:
  - bin/test -s Products.CMFPlomino  --all
after_script:
  - tail -n +1 parts/test/test_plominodatabase/*/*.xml
  - travis-artifacts upload --path parts/test

notifications:
  irc:
    - "irc.freenode.org#plomino"
